---
lab:
  title: Azure AI Vision カスタム モデルを使用して画像を分類する
  module: Module 2 - Develop computer vision solutions with Azure AI Vision
---

# Azure AI Vision カスタム モデルを使用して画像を分類する

Azure AI Vision を使用すると、カスタム モデルをトレーニングして、指定したラベルを持つオブジェクトを分類して検出できます。 このラボでは、果物の画像を分類するカスタム画像分類モデルを構築します。

## Computer Vision リソースをプロビジョニングする

サブスクリプションに **Computer Vision** リソースがまだない場合は、プロビジョニングする必要があります。

1. Azure portal (`https://portal.azure.com`) を開き、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
1. **[リソースの作成]** を選択します。
1. 検索バーで *Computer Vision* を検索し、**[Computer Vision]** を選択して、次の設定でリソースを作成します。
    - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
    - **リソース グループ**: *リソース グループを選択または作成します (制限付きサブスクリプションを使用している場合は、新しいリソース グループを作成する権限がないことがあります。提供されているものを使ってください)*
    - **リージョン**: *米国東部、米国西部、フランス中部、韓国中部、北ヨーロッパ、東南アジア、西ヨーロッパ、東アジアから選択します\**
    - **[名前]**: *一意の名前を入力します*
    - **価格レベル**: Free F0

    \*Azure AI Vision 4.0 の機能は、現在、これらのリージョンでのみ使用できます。

1. 必要なチェック ボックスをオンにして、リソースを作成します。
<!--4. When the resource has been deployed, go to it and view its **Keys and Endpoint** page. You will need the endpoint and one of the keys from this page in a future step. Save them off or leave this browser tab open.-->

トレーニング イメージを格納するためのストレージ アカウントも必要です。

1. Azure portal で**ストレージ アカウント**を検索して選択し、次の設定で新しいストレージ アカウントを作成します。
    - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
    - **[リソース グループ]**: Custom Vision リソースを作成したのと同じリソース グループを選択します**
    - **ストレージ アカウント名**: customclassifySUFFIX 
        - 注: リソース名がグローバルに一意になるように、`SUFFIX` トークンをイニシャルまたは別の値に置き換えます。**
    - **リージョン**: *Azure AI サービス リソースに使用したリージョンと同じものを選択します*
    - **プライマリ サービス**: Azure Blob Storage または Azure Data Lake Storage Gen 2
    - **プライマリ ワークロード**: その他
    - **パフォーマンス**: 標準
    - **冗長**: ローカル冗長ストレージ (LRS)

1. リソースがデプロイされたら、**[リソースに移動]** を選択します。
1. ストレージ アカウントのパブリック アクセスを有効にします。 左側のウィンドウで、**[設定]** グループの **[構成]** に移動し、*[BLOB の匿名アクセスを許可する]* を有効にします。 **[保存]** を選びます。
1. 左側のウィンドウの **[データ ストレージ]** で、**[コンテナー]** を選択し、「`fruit`」という名前の新しいコンテナーを作成し、**[匿名アクセス レベル]** を *[コンテナー (コンテナーと BLOB の匿名読み取りアクセス)]* に設定します。

    > **注**: **匿名アクセス レベル**が無効になっている場合は、ブラウザー ページを更新します。
   
## このコースのリポジトリを複製する

モデルをトレーニングするための画像ファイルは、GitHub リポジトリで提供されています。 リポジトリをクローンし、Azure Portal から Cloud Shell を使用してストレージ アカウントに画像をアップロードします。 

> **ヒント**: 既に **mslearn-ai-vision** リポジトリを最近クローンした場合は、このクローン タスクをスキップできます。 それ以外の場合は、次の手順に従って開発環境にリポジトリをクローンします。

1. Azure portal で、ページ上部の検索バーの右側にある **[\>_]** ボタンを使用して、Azure portal に新しい Cloud Shell を作成し、***PowerShell*** 環境を選択します。 Azure portal の下部にあるペインに、Cloud Shell のコマンド ライン インターフェイスが表示されます。

    > **注**: *Bash* 環境を使用するクラウド シェルを以前に作成した場合は、それを ***PowerShell*** に切り替えます。

1. Cloud Shell ツール バーの **[設定]** メニューで、**[クラシック バージョンに移動]** を選択します (これはコード エディターを使用するのに必要です)。

    > **ヒント**: Cloudshell にコマンドを貼り付けると、出力が大量のスクリーン バッファーを占有する可能性があります。 `cls` コマンドを入力して、各タスクに集中しやすくすることで、スクリーンをクリアできます。

1. PowerShell ペインで、次のコマンドを入力して、この演習用の GitHub リポジトリを複製します。

    ```
    rm -r mslearn-ai-vision -f
    git clone https://github.com/microsoftlearning/mslearn-ai-vision mslearn-ai-vision
    ```

1. リポジトリがクローンされたら、演習ファイルが格納されているフォルダーに移動します。  

    ```
   cd mslearn-ai-vision/Labfiles/02-image-classification
    ```

1. コマンド `code replace.ps1` を実行し、コードを確認します。 後の手順で使用する JSON ファイル (COCO ファイル) のプレースホルダーのストレージ アカウントの名前が置き換えられていることがわかります。
1. ファイルの *1 行目のみ*にあるプレースホルダーを、お使いのストレージ アカウントの名前に置き換えます。
1. プレースホルダーを置き換えた後、コード エディター内で、**Ctrl + S** キー コマンドまたは**右クリック > [保存]** を使用して変更を保存し、**Ctrl + Q** キー コマンドまたは**右クリック > [終了]** を使用して、Cloud Shell コマンド ラインを開いたままコード エディターを閉じます。
1. 次のコマンドを使用してこのスクリプトを実行します。

    ```powershell
    ./replace.ps1
    ```

1. COCO ファイルを確認して、お使いのストレージ アカウント名が存在することを確認できます。 `code training-images/training_labels.json` を実行し、最初のいくつかのエントリを確認します。 *[absolute_url]* フィールドに *"https://myStorage.blob.core.windows.net/fruit/...* のように表示されます。変更が正常に表示されていない場合は、PowerShell スクリプトの 1 行目のプレースホルダーのみを更新したことを確認してください。
1. コード エディターを閉じます。
1. `<your-storage-account>` をストレージ アカウントの名前に置き換えて次のコマンドを実行し、**training-images** フォルダーの内容を、先ほど作成した `fruit` コンテナーにアップロードします。

    ```powershell
    az storage blob upload-batch --account-name <your-storage-account> -d fruit -s ./training-images/
    ```

1. `fruit` コンテナーを開き、ファイルが正しくアップロードされたことを確認します。

## カスタム モデルのトレーニング プロジェクトを作成する

次に、Vision Studio でカスタム画像分類用の新しいトレーニング プロジェクトを作成します。

1. Web ブラウザーで `https://portal.vision.cognitive.azure.com/` に移動し、Azure AI リソースを作成した Microsoft アカウントでサインインします。
1. **[画像を使用してモデルをカスタマイズする]** タイルを選択します（既定のビューに表示されていない場合は、**[画像分析]** タブにあります）。
1. 作成した Azure AI サービス アカウントを選択します。
1. プロジェクトで、上部にある **[新しいデータセットの追加]** を選択します。 次の設定で  を構成します。
    - **データセット名**: training_images
    - **モデルの種類**: 画像分類
    - **Azure Blob Storage コンテナーの選択**: **[コンテナーの選択]** を選択します
        - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
        - **ストレージ アカウント**: *作成したストレージ アカウント*
        - **BLOB コンテナー**: 果物
    - [Vision Studio による Blob Storage への読み取りと書き込みを許可する] ボックスを選択します
1. **training_images** データセットを選択します。

プロジェクト作成のこの時点で、通常は **[Azure ML データのラベル付けプロジェクトを作成する]** を選択し、画像にラベルを付けます。これにより COCO ファイルが生成されます。 時間がある場合は、これを試してみることをお勧めしますが、このラボでは既に画像にラベルを付けた作成済みの COCO ファイルを提供しています。

1. **[COCO ファイルの追加]** を選択します。
1. ドロップダウンで、**[Blob コンテナーから COCO ファイルをインポートする]** を選択します。
1. `fruit` という名前のコンテナーを既に接続しているため、Vision Studio はこのコンテナーで COCO ファイルを検索します。 ドロップダウンから **training_labels.json** を選択し、COCO ファイルを追加します。
1. 左側の **[カスタム モデル]** に移動し、**[新しいモデルのトレーニング]** を選択します。 次の設定を使用します。
    - **モデルの名前**: classifyfruit
    - **モデルの種類**: 画像分類
    - **トレーニング データセットの選択**: training_images
    - 残りは既定値のままにして、**[モデルのトレーニング]** を選択します。

トレーニングには時間がかかる場合があります。既定の予測時間は最大 1 時間ですが、このデータセットは小さいため、通常はそれよりもかなり短時間で完了します。 ジョブの状態が *[成功]* になるまで、数分ごとに **[更新]** ボタンを選択します。 モデルを選択します。

ここでは、トレーニング ジョブのパフォーマンスを表示できます。 トレーニング済みモデルの精度と正確性を確認します。

## カスタム モデルをテストする

モデルのトレーニングが完了し、テストする準備ができました。

1. カスタム モデルのページの上部にある **[試してみる]** を選択します。
1. ドロップダウンから **classifyfruit** モデルを選択して使用するモデルを指定し、**02-image-classification\test-images** フォルダーを参照します。
1. 各画像を選択し、結果を表示します。 結果のボックスで **[JSON]** タブを選択して、完全な JSON 応答を確認します。

<!-- Option coding example to run-->
## リソースをクリーンアップする

このラボで作成した Azure リソースを他のトレーニング モジュールに使用していない場合は、それらを削除して、追加料金が発生しないようにすることができます。

1. `https://portal.azure.com` で Azure portal を開き、上部の検索バーで、このラボで作成したリソースを検索します。

2. [リソース] ページで **[削除]** を選択し、指示に従ってリソースを削除します。 または、リソース グループ全体を削除して、すべてのリソースを同時にクリーンアップすることもできます。
