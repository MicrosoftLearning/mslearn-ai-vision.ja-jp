---
lab:
  title: Azure AI Custom Vision を使用して画像を分類する
---

# Azure AI Custom Vision を使用して画像を分類する

**Azure AI Custom Vision** サービスを使用すると、独自の画像でトレーニングされた Computer Vision モデルを作成できます。 これを使用して、*画像分類* および *物体検出* モデルをトレーニングできます。その後、公開してアプリケーションから利用できます。

この演習では、Computer Vision サービスを使用して、果物の 3 つのクラス (リンゴ、バナナ、オレンジ) を識別できる画像分類モデルをトレーニングします。

## Custom Vision リソースを作成する

モデルをトレーニングする前に、*トレーニング* と *予測* のために Azure リソースが必要になります。 これらのタスクごとに **Custom Vision** リソースを作成することも、単一の **Azure AI サービス** リソースを作成していずれか (または両方) に使用することもできます。

この演習では、トレーニングと予測用の **Custom Vision** リソースを作成して、これらのワークロードのアクセスとコストを個別に管理できるようにします。

1. 新しいブラウザー タブで Azure portal (`https://portal.azure.com`) を開き、自分の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
1. **[&#65291;リソースの作成]** ボタンを選択し、*custom vision* を検索して、次の設定で **Custom Vision** リソースを作成します。
    - **作成オプション**: 両方
    - **[サブスクリプション]**:*ご自身の Azure サブスクリプション*
    - **リソース グループ**: *リソース グループを選択または作成します (制限付きサブスクリプションを使用している場合は、新しいリソース グループを作成する権限がないことがあります。提供されているものを使ってください)*
    - **[リージョン]**: 使用できるリージョンを選択します**
    - **[名前]**: *一意の名前を入力します*
    - **トレーニング価格レベル**: F0
    - **[予測価格レベル]**: F0

    > **注**: サブスクリプションに既に F0 Custom Vision サービスがある場合は、このサービスに **S0** を選択してください。

1. リソースが作成されるのを待ってから、デプロイの詳細を表示し、2 つの Custom Vision リソースがプロビジョニングされていることに注意してください。1 つはトレーニング用で、もう 1 つは予測用です ( **-Prediction** サフィックスで示されます)。 これらを作成したリソース グループに移動すると、これらを表示できます。

> **重要**: 各リソースには独自の *エンドポイント* と *キー* があり、コードからのアクセスを管理するために使用されます。 画像分類モデルをトレーニングするには、コードで *トレーニング* リソース (エンドポイントとキーを含む) を使用する必要があります。トレーニング済みモデルを使用して画像クラスを予測するには、コードで *予測* リソース (エンドポイントとキーを含む) を使用する必要があります。

## このコースのリポジトリを複製する

Azure portal から Cloud Shell を使用してコード開発を行います。 アプリのコード ファイルは、GitHub リポジトリで提供されています。

> **ヒント**: 最近 **mslearn-ai-vision** リポジトリを既に複製した場合は、このタスクをスキップできます。 それ以外の場合は、次の手順に従って開発環境に複製します。

1. Azure portal で、ページ上部の検索バーの右側にある **[\>_]** ボタンを使用して、Azure portal に新しい Cloud Shell を作成し、***PowerShell*** 環境を選択します。 Azure portal の下部にあるペインに、Cloud Shell のコマンド ライン インターフェイスが表示されます。

    > **注**: *Bash* 環境を使用するクラウド シェルを以前に作成した場合は、それを ***PowerShell*** に切り替えます。

1. Cloud Shell ツール バーの **[設定]** メニューで、**[クラシック バージョンに移動]** を選択します (これはコード エディターを使用するのに必要です)。

    > **ヒント**: Cloudshell にコマンドを貼り付けると、出力が大量のスクリーン バッファーを占有する可能性があります。 `cls` コマンドを入力して、各タスクに集中しやすくすることで、スクリーンをクリアできます。

1. PowerShell ペインで、次のコマンドを入力して、この演習用の GitHub リポジトリを複製します。

    ```
    rm -r mslearn-ai-vision -f
    git clone https://github.com/microsoftlearning/mslearn-ai-vision mslearn-ai-vision
    ```

1. リポジトリが複製されたら、アプリケーション コード ファイルを含んだフォルダーに移動します。  

    ```
   cd mslearn-ai-vision/Labfiles/07-custom-vision-image-classification
    ```
    
## Custom Vision プロジェクトを作成する

画像分類モデルをトレーニングするには、トレーニング リソースに基づいて Custom Vision プロジェクトを作成する必要があります。 これを行うには、Custom Vision ポータルを使用します。

1. `https://github.com/MicrosoftLearning/mslearn-ai-vision/raw/main/Labfiles/07-custom-vision-image-classification/training-images.zip` からトレーニング画像をダウンロードし、zip フォルダーを展開してその内容を表示します。 このフォルダーには、リンゴ、バナナ、オレンジの画像のサブフォルダーが含まれています。
1. 新しいブラウザー タブで、`https://customvision.ai` の Custom Vision ポータルを開きます。 ダイアログが表示されたら、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインして、サービス利用規約に同意します。
1. Custom Vision ポータルで、次の設定を使って新しいプロジェクトを作成します。
    - **名前**: フルーツの分類
    - **説明**: フルーツの画像分類
    - **リソース**: 以前に作成した Custom Vision リソース**
    - **プロジェクトの種類**: Classification
    - **分類の種類**: Multiclass (Single tag per image)
    - **ドメイン**: 食品
1. 新しいプロジェクトで、 **\[+\] イメージの追加** をクリックし、前に表示した **training-images/apple** フォルダー内のすべてのファイルを選択します。 次のように *apple* というタグを指定して、画像ファイルをアップロードします。

![apple タグを指定してアップロードする](../media/upload_apples.jpg)
   
1. 前の手順を繰り返し、**banana** フォルダー内の画像には *banana* タグを、**orange** フォルダー内の画像には *orange* タグを付けてアップロードします。
1. Custom Vision プロジェクトでアップロードした画像を探します。次のように各クラスの画像が 15 個あるはずです。

![タグ付けされた果物の画像 - りんご 15 個、バナナ 15 個、みかん 15 個](../media/fruit.jpg)
    
1. Custom Vision プロジェクトで、画像の上にある **[トレーニング]** をクリックして、タグ付けされた画像を使って分類モデルをトレーニングします。 **クイック トレーニング** オプションを選び、トレーニングの反復が完了するまで待ちます (1 分ほどかかる場合があります)。
1. モデルの反復をトレーニングしたら、*Precision*、*Recall*、*AP* のパフォーマンス メトリックを確認します。これらは分類モデルの予測精度を測るものであり、すべて高くするようにします。

> **注**: パフォーマンス メトリックは、各予測の 50% の確率しきい値に基づいています (つまり、モデルが特定のクラスの画像である確率が 50% 以上であると計算した場合、そのクラスが予測されます)。 これはページの左上で調整できます。

## モデルのテスト

モデルをトレーニングしたので、テストできます。

1. パフォーマンス メトリックの上にある **Quick Test** をクリックします。
1. **Image URL** ボックスに「`https://aka.ms/apple-image`」と入力し、➔ をクリックします。
1. モデルによって返される予測を確認します。次のように *apple* の確率スコアが最も高くなるはずです。

![apple のクラス予測を含むイメージ](../media/test-apple.jpg)

1. その後、**Quick Test** ウィンドウを閉じます。

## プロジェクト設定を表示する

作成したプロジェクトには一意の識別子が割り当てられており、それを操作するコードで指定する必要があります。

1. **Performance** ページの右上にある *設定* (&#9881;) アイコンをクリックして、プロジェクトの設定を表示します。
1. **General** (左側) の下で、このプロジェクトを一意に識別する **[プロジェクト ID]** に注意してください。
1. 右側の **[リソース]** の下に、キーとエンドポイントが表示されていることに注意してください。 これらは、*トレーニング* リソースの詳細です (この情報は、Azure portal でリソースを表示することでも取得できます)。

## *トレーニング* API を使用する

Custom Vision ポータルは、画像のアップロードとタグ付け、およびモデルのトレーニングに使用できる便利なユーザー インターフェイスを提供します。 ただし、シナリオによっては、Custom Vision トレーニング API を使用してモデル トレーニングを自動化することができます。

> **注**: この演習では、**C#** または **Python** SDK のいずれかから API を使用することを選択できます。 以下の手順で、希望する言語に適したアクションを実行します。

1. Azure portal に戻り、言語の設定に応じてコマンド `cd C-Sharp/train-classifier` または `cd Python/train-classifier` を実行します。
1. 言語の設定に適したコマンドを実行して、Custom Vision トレーニング パッケージをインストールします。

    **C#**

    ```
    dotnet add package Microsoft.Azure.CognitiveServices.Vision.CustomVision.Training --version 2.0.0
    ```

    **Python**

    ```
    pip install azure-cognitiveservices-vision-customvision==3.1.0
    ```

1. `ls` コマンドを使用すると、**train-classifier** フォルダーの内容を表示できます。これには、構成設定用のファイルが含まれていることに注意してください。
    - **C#**: appsettings.json
    - **Python**: .env

1. 次のコマンドを入力して、提供されている構成ファイルを編集します。

    **C#**

    ```
   code appsettings.json
    ```

    **Python**

    ```
   code .env
    ```

    このファイルをコード エディターで開きます。

1. コード ファイル内で、含まれている構成値を更新して、Custom Vision "トレーニング" リソースの**エンドポイント**と認証**キー**、および以前に作成した物体検出プロジェクトのプロジェクト ID を反映します。**
1. プレースホルダーを置き換えたら、コード エディター内で、**Ctrl + S** コマンドを使用するか、**右クリックして保存**で変更を保存してから、**Ctrl + Q** コマンドを使用するか、**右クリックして終了**で、Cloud Shell コマンド ラインを開いたままコード エディターを閉じます。
1. **train-classifier** フォルダーには、クライアント アプリケーションのコード ファイルが含まれていることに注意してください。

    - **C#** : Program.cs
    - **Python**: train-classifier.py

    コード ファイルを開き、含まれているコードを確認して、次の詳細に注意してください。
    - インストールしたパッケージの名前空間インポートされます
    - **Main** 関数は、構成設定を取得し、キーとエンドポイントを使用して認証済みの **CustomVisionTrainingClient** を作成します。これは、プロジェクト ID とともに使用され、プロジェクトへの**プロジェクト**参照を作成します。
    - **Upload_Images** 関数は、Custom Vision プロジェクトで定義されているタグを取得し、対応する名前のフォルダーからプロジェクトに画像ファイルをアップロードして、適切なタグ ID を割り当てます。
    - **Train_Model** 関数は、プロジェクトの新しいトレーニング反復を作成し、トレーニングが完了するのを待ちます。
1. コード エディターを閉じ、次のコマンドを入力してプログラムを実行します。

    **C#**

    ```
    dotnet run
    ```

    **Python**

    ```
    python train-classifier.py
    ```
    
1. プログラムが終了するのを待ちます。 次に、ブラウザーに戻り、Custom Vision ポータルでプロジェクトの **Training Images** ページを表示します (必要に応じてブラウザーを更新します)。
1. いくつかの新しいタグ付き画像がプロジェクトに追加されていることを確認します。 次に、 **Performance** ページを表示し、新しいイテレーションが作成されたことを確認します。

## 画像分類モデルを発行する

これで、トレーニング済みモデルを公開して、クライアント アプリケーションから使用できるようにする準備が整いました。

1. Custom Vision ポータルの **Performance** ページで、 **[&#128504; Publish]** をクリックして、トレーニング済みモデルを次の設定で公開します。
    - **モデル名**: fruit-classifier
    - **予測リソース**: *前に作成した "-Prediction" で終わる**予測**リソース (トレーニング リソースでは<u>ありません</u>)。*
1. **[プロジェクト設定]** ページの左上にある *[プロジェクトギャラリー]* (👁) アイコンをクリックして、プロジェクトが一覧表示されている Custom Vision ポータルの [ホーム] ページに戻ります。
1. Custom Vision ポータルの [ホーム] ページの右上にある *設定* (&#9881;) アイコンをクリックして、Custom Vision サービスの設定を表示します。 次に、 **[リソース]** の下で、"-Prediction" で終わる *予測* リソース (トレーニング リソースでは<u>ありません</u>) を見つけて、その**キー**と**エンドポイント**の値を確認します (この情報は、Azure portal のリソースで表示して取得することもできます)。

## クライアント アプリケーションからの画像分類子を使用する

画像分類モデルを公開したので、クライアント アプリケーションからそれを使用できます。 ここでも、**C#** または **Python** のどちらを使用するかを選択できます。

1. Cloud Shell に戻り、コマンド `cd ../test-classifier` を実行してから、SDK 固有の次のコマンドを入力して Custom Vision 予測パッケージをインストールします。

    **C#**

    ```
    dotnet add package Microsoft.Azure.CognitiveServices.Vision.CustomVision.Prediction --version 2.0.0
    ```

    **Python**

    ```
    pip install azure-cognitiveservices-vision-customvision==3.1.0
    ```

> **注**: Python SDK パッケージには、トレーニング パッケージと予測パッケージの両方が含まれており、既にインストールされている場合があります。

1. `ls` コマンドを使用すると、画像分類モデルのテスト クライアント アプリケーションを実行するために使用される **test-classifier** フォルダーの内容を表示できます。
1. クライアントアプリケーションの構成ファイル (C# の場合は *appsettings.json*、Python の場合は *.env*) を開き、Custom Vision *予測* リソースのエンドポイントとキー、分類プロジェクトのプロジェクト ID、および公開されたモデルの名前 (*fruit-classifier* である必要があります) を反映するように、含まれている構成値を更新します。 変更を保存し、コード エディターを閉じます。
1. クライアント アプリケーションのコード ファイル (C# の場合は *Program.cs*、Python の場合は *test-classification.py*) を開き、含まれているコードを確認して、次の詳細に注意してください。
    - インストールしたパッケージの名前空間インポートされます
    - **Main** 関数は構成設定を取得し、キーとエンドポイントを使用して認証済みの **CustomVisionPredictionClient** を作成します。
    - 予測クライアント オブジェクトは、**test-images** フォルダー内の各画像のクラスを予測するために使用され、各リクエストのプロジェクト ID とモデル名を指定します。 各予測には、可能なクラスごとの確率が含まれ、確率が 50% を超える予測タグのみが表示されます。
1. コード エディターを閉じ、SDK 固有の次のコマンドを入力してプログラムを実行します。

    **C#**

    ```
    dotnet run
    ```

    **Python**

    ```
    python test-classifier.py
    ```

1. 各予測のラベル (タグ) ）と確率スコアを表示します。 **test-images** フォルダー内の画像をダウンロードすると、それらがモデルによって正しく分類されたことを確認できます。

1. Cloud Shell のツール バーで、**[ファイルのアップロード/ダウンロード]**、**[ダウンロード]** の順に選択します。 新しいダイアログ ボックスで、次のファイル パスを入力し、**[ダウンロード]** を選択します。

    **C#**
   
    ```
   mslearn-ai-vision/Labfiles/07-custom-vision-image-classification/C-Sharp/test-classifier/test-images/IMG_TEST_1.jpg
    ```

    **Python**
   
    ```
   mslearn-ai-vision/Labfiles/07-custom-vision-image-classification/Python/test-classifier/test-images/IMG_TEST_1.jpg
    ```

   同じパスを使用して `IMG_TEST_2.jpg` と `IMG_TEST_3.jpg` をダウンロードすることもできます。

## リソースをクリーンアップする

このラボで作成した Azure リソースを他のトレーニング モジュールに使用していない場合は、それらを削除して、追加料金が発生しないようにすることができます。

1. `https://portal.azure.com` で Azure portal を開き、上部の検索バーで、このラボで作成したリソースを検索します。

1. [リソース] ページで **[削除]** を選択し、指示に従ってリソースを削除します。 または、リソース グループ全体を削除して、すべてのリソースを同時にクリーンアップすることもできます。

## 詳細

Custom Vision サービスを使用した画像分類の詳細については、[Custom Vision のドキュメント](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/)を参照してください。
