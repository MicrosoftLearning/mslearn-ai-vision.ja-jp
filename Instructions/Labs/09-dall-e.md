---
lab:
  title: AI を使用して画像を生成する
  description: Azure AI Foundry で OpenAI DALL-E モデルを使用してイメージを生成します。
---

# AI を使用して画像を生成する

この演習では、OpenAI DALL-E 生成 AI モデルを使用して画像を生成します。 また、OpenAI Python SDK を使用して、プロンプトに基づいてイメージを生成するシンプルなアプリを作成します。

> **注**:この演習は、変更される可能性があるプレリリース SDK ソフトウェアに基づいています。 必要に応じて、特定のバージョンのパッケージを使用しました。利用可能な最新バージョンが反映されていない可能性があります。 予期しない動作、警告、またはエラーが発生する場合があります。

この演習は、OpenAI Python SDK に基づいていますが、次のような複数の言語固有の SDK を使用して AI チャット アプリケーションを開発することができます。

* [Microsoft .NET 向け OpenAI プロジェクト](https://www.nuget.org/packages/OpenAI)
* [JavaScript 向け OpenAI プロジェクト](https://www.npmjs.com/package/openai)

この演習は約 **30** 分かかります。

## Azure AI Foundry ポータルを開く

まず、Azure AI Foundry ポータルにサインインしましょう。

1. Web ブラウザーで [Azure AI Foundry ポータル](https://ai.azure.com) (`https://ai.azure.com`) を開き、Azure 資格情報を使用してサインインします。 初めてサインインするときに開いたヒントまたはクイック スタート ウィンドウを閉じます。また、必要に応じて左上にある **Azure AI Foundry** ロゴを使用してホーム ページに移動します。それは次の画像のようになります (**[ヘルプ]** ウィンドウが開いている場合は閉じます)。

    ![Azure AI Foundry ポータルのスクリーンショット。](./media/ai-foundry-home.png)

1. ホーム ページの情報を確認します。

## プロジェクトを開始するモデルを選択する

Azure AI *プロジェクト*には、AI 開発のための共同ワークスペースが用意されています。 まず、使用するモデルを選択し、それを使用するプロジェクトを作成しましょう。

> **注**: AI Foundry プロジェクトは *Azure AI Foundry* リソースをベースにすることができます。このリソースが、AI モデル (Azure OpenAI を含む)、Azure AI サービス、AI エージェントやチャット ソリューションを開発するためのその他のリソースへのアクセスを提供します。 または、*AI ハブ* リソースに基づいてプロジェクトを作成することもできます。このリソースには、セキュリティで保護されたストレージ、コンピューティング、専用のツールに使用する Azure リソースへの接続が含まれます。 Azure AI Foundry ベースのプロジェクトは、AI エージェントまたはチャット アプリ開発のリソースの管理を希望する開発者に最適です。 複雑な AI ソリューションに取り組むエンタープライズ開発チームには、AI ハブ ベースのプロジェクトの方が適しています。

1. ホーム ページの **[モデルと機能を調査する]** セクションで、プロジェクトで使用する `dall-e-3` モデルを検索します。

1. 検索結果で **dall-e-3** モデルを選んで詳細を確認してから、モデルのページの上部にある **[このモデルを使用する]** を選択します。

1. プロジェクトの作成を求められたら、プロジェクトの有効な名前を入力し、**[詳細]** オプションを展開します。

1. **[カスタマイズ]** を選択し、ハブに次の設定を指定します。
    - **Azure AI Foundry リソース**: *Azure AI Foundry リソースの有効な名前*
    - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
    - **リソース グループ**: *リソース グループを作成または選択します*
    - **リージョン**: **AI Foundry が推奨する**もの*の中から選択します\*

    > \* 一部の Azure AI リソースは、リージョンのモデル クォータによって制限されます。 演習の後半でクォータ制限を超えた場合は、別のリージョンに別のリソースを作成する必要が生じる可能性があります。

1. **[作成]** を選択し、選んだ dall-e-3 モデル デプロイを含むプロジェクトが作成されるまで待ちます。

    > 注:モデルの選択によっては、プロジェクトの作成プロセス中に追加のプロンプトが表示される場合があります。 使用条件に同意し、デプロイを完了します。

1. プロジェクトが作成されると、モデルが **[モデル + エンドポイント]** ページに表示されます。

## プレイグラウンドでモデルをテストする

クライアント アプリケーションを作成する前に、プレイグラウンドで DALL-E モデルをテストしましょう。

1. **[プレイグラウンド]**、**[イメージ プレイグラウンド]** の順に選択します。

1. DALL-E モデルのデプロイが選択されていることを確認します。 次に、ページの最下部近くのボックスに、`Create an image of an robot eating spaghetti` などのプロンプトを入力し、**[生成する]** を選択します。

1. プレイグラウンドで結果の画像を確認します。

    ![生成された画像を含む画像プレイグラウンドのスクリーンショット。](../media/images-playground.png)

1. `Show the robot in a restaurant`などのフォローアップ プロンプトを入力し、結果の画像を確認します。

1. 新しいプロンプトでテストを続けて、満足のいく結果が得られるまで画像の条件を絞ります。 

1. **\</\>[コードの表示]** ボタンを選択し、**[Entra ID 認証]** タブが表示されていることを確認します。次に、演習の後半で使用するために次の情報を記録します。 値は例であることに注意してください。ご自分のデプロイの情報を忘れずに記録してください。

    * OpenAI エンドポイント: *https://dall-e-aus-resource.cognitiveservices.azure.com/*
    * OpenAI API のバージョン:*2024-04-01-preview*
    * デプロイ名 (モデル名): *dall-e-3*

## クライアント アプリケーションを作成する

モデルはプレイグラウンドで動作するようです。 これで、OpenAI SDK を使用してクライアント アプリケーションで使用できるようになりました。

### アプリケーション構成を準備する

1. 新しいブラウザー タブを開きます (既存のタブで Azure AI Foundry ポータルを開いたままにします)。 新しいブラウザー タブで [Azure portal](https://portal.azure.com) (`https://portal.azure.com`) を開き、メッセージに応じて Azure 資格情報を使用してサインインします。

1. ページ上部の検索バーの右側にある **[\>_]** ボタンを使用して、Azure portal に新しい Cloud Shell を作成します。***PowerShell*** 環境を選択します。 Azure portal の下部にあるペインに、Cloud Shell のコマンド ライン インターフェイスが表示されます。

    > **注**: *Bash* 環境を使用するクラウド シェルを以前に作成した場合は、それを ***PowerShell*** に切り替えます。

    > **注**:ファイルを保持するストレージを選択するようにポータルから求められた場合は、**[ストレージ アカウントは必要ありません]** を選択し、お使いのサブスクリプションを選択して、**[適用]** キーを選択します。

1. Cloud Shell ツール バーの **[設定]** メニューで、**[クラシック バージョンに移動]** を選択します (これはコード エディターを使用するのに必要です)。

    **<font color="red">続行する前に、クラシック バージョンの Cloud Shell に切り替えたことを確認します。</font>**

1. Cloud Shell 画面で、次のコマンドを入力して、この演習のコード ファイルを含む GitHub リポジトリをクローンします (コマンドを入力するか、クリップボードにコピーしてから、コマンド ラインで右クリックし、プレーンテキストとして貼り付けます)。

    ```
    rm -r mslearn-ai-vision -f
    git clone https://github.com/MicrosoftLearning/mslearn-ai-vision
    ```

    > **ヒント**: Cloudshell にコマンドを貼り付けると、出力が大量のスクリーン バッファーを占有する可能性があります。 `cls` コマンドを入力して、各タスクに集中しやすくすることで、スクリーンをクリアできます。

1. リポジトリが複製されたら、アプリケーション コード ファイルを含むフォルダーに移動します。  

    ```
   cd mslearn-ai-vision/Labfiles/dalle-client/python
    ```

1. Cloud Shell コマンド ライン ペインで、次のコマンドを入力して、これから使用するライブラリをインストールします。

    ```
   python -m venv labenv
   ./labenv/bin/Activate.ps1
   pip install -r requirements.txt azure-identity openai requests
    ```

1. 次のコマンドを入力して、提供されている構成ファイルを編集します。

    ```
   code .env
    ```

    このファイルをコード エディターで開きます。

1. **your_endpoint**、**your_model_deployment**、**your_api_version** プレースホルダーを、**イメージ プレイグラウンド**から記録した値に置き換えます。

1. プレースホルダーを置き換えたら、**Ctrl + S** キー コマンドを使用して変更を保存してから、**Ctrl + Q** キー コマンドを使用して、Cloud Shell コマンド ラインを開いたままコード エディターを閉じます。

### プロジェクトに接続してモデルとチャットするためのコードを記述する

> **ヒント**: コードを追加する際は、必ず正しいインデントを維持してください。

1. 次のコマンドを入力して、提供されているコード ファイルを編集します。

    ```
   code dalle-client.py
    ```

1. コード ファイルで、ファイルの先頭に追加された既存のステートメントを書き留めて、必要な SDK 名前空間をインポートします。 次に、コメント**参照の追加**の下に、次のコードを追加して、前にインストールしたライブラリの名前空間を参照します。

    ```python
   # Add references
   from dotenv import load_dotenv
   from azure.identity import DefaultAzureCredential, get_bearer_token_provider
   from openai import AzureOpenAI
   import requests
    ```

1. **main** 関数の **Get configuration settings (構成設定を取得する)** というコメントの下に、構成ファイルで定義したエンドポイント API バージョンとモデル デプロイ名の値がコードで読み込まれることに注目してください。

1. **Initialize the client (クライアントを初期化する)** というコメントの下に、次のコードを追加して、現在のサインインに使用した Azure 資格情報でモデルに接続します。

    ```python
   # Initialize the client
   token_provider = get_bearer_token_provider(
       DefaultAzureCredential(exclude_environment_credential=True,
           exclude_managed_identity_credential=True), 
       "https://cognitiveservices.azure.com/.default"
   )
    
   client = AzureOpenAI(
       api_version=api_version,
       azure_endpoint=endpoint,
       azure_ad_token_provider=token_provider
   )
    ```

1. コードには、ユーザーが「quit」と入力するまでプロンプトを入力できるようにするループが含まれていることに注意してください。 次に、ループ セクションのコメント**画像の生成**で、次のコードを追加して、プロンプトを送信し、モデルから生成された画像の URL を取得します。

    **Python**

    ```python
   # Generate an image
   result = client.images.generate(
        model=model_deployment,
        prompt=input_text,
        n=1
    )

   json_response = json.loads(result.model_dump_json())
   image_url = json_response["data"][0]["url"] 
    ```

1. **main** 関数の残りの部分のコードは、画像の URL とファイル名を指定された関数に渡します。これにより、生成された画像がダウンロードされ、.png ファイルとして保存されます。

1. **Ctrl + S** キー コマンドを使用してコード ファイルに変更を保存してから、**Ctrl + Q** キー コマンドを使用して、Cloud Shell コマンド ラインを開いたままコード エディターを閉じます。

### クライアント アプリケーションを実行する

1. Cloud Shell コマンド ライン ペインで、次のコマンドを入力してアプリを実行します。

    ```
   az login
    ```

    **<font color="red">Cloud Shell セッションが既に認証されている場合でも、Azure にサインインする必要があります。</font>**

    > **注**: ほとんどのシナリオでは、*az ログイン*を使用するだけで十分です。 ただし、複数のテナントにサブスクリプションがある場合は、*[--tenant]* パラメーターを使用してテナントを指定する必要があります。 詳細については、「[Azure CLI を使用して対話形式で Azure にサインインする](https://learn.microsoft.com/cli/azure/authenticate-azure-cli-interactively)」を参照してください。

1. メッセージが表示されたら、指示に従って新しいタブでサインイン ページを開き、指定された認証コードと Azure 資格情報を入力します。 次に、コマンド ラインでサインイン プロセスを完了し、プロンプトが表示されたら、Azure AI Foundry ハブを含むサブスクリプションを選択します。

1. Cloud Shell コマンド ライン ペインで、次のコマンドを入力してアプリを実行します。

    ```
   python dalle-client.py
    ```

1. メッセージが表示されたら、`Create an image of a robot eating pizza`などの画像のリクエストを入力します。 しばらくすると、アプリは画像が保存されたことを確認する必要があります。

1. いくつかのプロンプトを試してみましょう。 終了したら、`quit` を入力してプログラムを終了します。

    > **注**: このシンプルなアプリには、会話履歴を保持するためのロジックが含まれていないので、モデルは、各プロンプトを前のプロンプトのコンテキストを持たない新しいリクエストとして処理します。

1. アプリによって生成された画像をダウンロードして表示するには、Cloud Shell **ダウンロード** コマンドを使用して、生成された.png ファイルを指定します。

    ```
   download ./images/image_1.png
    ```

    ダウンロード コマンドを実行すると、ブラウザーの右下にポップアップ リンクが作成され、そこからファイルをダウンロードして開くことができます。

## まとめ

この演習では、Azure AI Foundry と Azure OpenAI SDK を使用し、DALL-E モデルを使用して画像を生成するクライアント アプリケーションを作成しました。

## クリーンアップ

DALL-E の探索が終わったら、不要な Azure コストが発生しないように、この演習で作成したリソースを削除する必要があります。

1. Azure portal が表示されているブラウザー タブに戻り (または、新しいブラウザー タブで `https://portal.azure.com` の [Azure portal](https://portal.azure.com) をもう一度開き)、この演習で使用したリソースがデプロイされているリソース グループの内容を表示します。
1. ツール バーの **[リソース グループの削除]** を選びます。
1. リソース グループ名を入力し、削除することを確認します。
